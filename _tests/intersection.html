<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <title>Collision Intersection Issue</title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
        body {
            padding: 1em;
            display: flex;
            justify-content: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin: 0 auto;
            gap: 1em;
            font-family: sans-serif;
        }
        canvas {
            background: hsl(0, 0%, 95%);
            display: block;
            transform-origin: top;
        }
        input {
            width: 5em;
            font-family: monospace;
            padding: 0.2em;
        }
        input[readonly] {
            background-color: hsl(0deg 0% 0% / 1%);
            border: 1px solid hsl(0deg 0% 80%);
            outline: none;
            color: hsl(0deg 0% 0% / 50%);
        }
        #stats {
            width: 100%;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>

<body>
    
    <div class="container">
        
        <canvas id="myCanvas" width="600" height="200"></canvas>
        
        <div id="stats">
            
            <table>
                <tr>
                    <td>
                        fps
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="fpsInput" />
                    </td>
                </tr>
                <tr>
                    <td>
                        canvas.width
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="canvasWidthInput" />
                    </td>
                </tr>
                <tr>
                    <td>
                        wall.width
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="wallWidthInput" />
                    </td>
                </tr>
                <tr>
                    <td>
                        ball.radius
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="ballRadiusInput" /> px
                    </td>
                </tr>
                <tr>
                    <td>
                        ball.xSpeed
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="ballXSpeedInput" /> px / s
                    </td>
                </tr>
            </table>
            
            <table>
                <tr>
                    <td>
                        leftWall.right
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="leftWallRightDisplay" value="0" readonly />
                    </td>
                </tr>
                <tr>
                    <td>
                        rightWall.left
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="rightWallLeftDisplay" value="0" readonly />
                    </td>
                </tr>
                <tr>
                    <td>
                        ball.x
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="ballXDisplay" value="0" readonly />
                    </td>
                </tr>
                <tr>
                    <td>
                        ball.left
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="ballLeftDisplay" value="0" readonly />
                    </td>
                </tr>
                <tr>
                    <td>
                        ball.right
                    </td>
                    <td>
                        &nbsp;
                        <input type="number" id="ballRightDisplay" value="0" readonly />
                    </td>
                </tr>
            </table>
            
        </div>
        
    </div>
    
    <script>
        // document.querySelector("canvas").style.scale = 1 / devicePixelRatio;
        
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");
        canvas.style.width  = canvas.width + "px";
        canvas.style.height = canvas.height + "px";
        
        let leftWall = {
            width: 100,
            height: canvas.height,
            x: 0,
            y: 0,
            draw: function () {
                ctx.beginPath();
                ctx.rect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = "hsl(0, 0%, 0%, 0.05)";
                ctx.fill();
                ctx.beginPath(this.x + this.width, this.y);
                ctx.lineWidth = 1;
                ctx.moveTo(this.x + this.width - 1 + 0.5, this.y);
                ctx.lineTo(this.x + this.width - 1 + 0.5, this.y + this.height);
                ctx.strokeStyle = "hsl(0, 0%, 0%, 0.1)";
                ctx.stroke();
            },
        };
        
        let rightWall = {
            width: 100,
            height: canvas.height,
            x: canvas.width - 100,
            y: 0,
            draw: function () {
                ctx.beginPath();
                ctx.rect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = "hsl(0, 0%, 0%, 0.05)";
                ctx.fill();
                ctx.beginPath(this.x, this.y);
                ctx.lineWidth = 1;
                ctx.moveTo(this.x + 0.5, this.y);
                ctx.lineTo(this.x + 0.5, this.y + this.height);
                ctx.strokeStyle = "hsl(0, 0%, 0%, 0.1)";
                ctx.stroke();
            },
        };
        
        let ball = {
            radius: 25,
            x: canvas.width / 2,
            y: canvas.height / 2,
            xSpeed: 85,
            xDir: Math.round(Math.random()) ? 1 : -1,
            draw: function () {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = "hsl(0, 60%, 50%, 0.2)";
                ctx.strokeStyle = "hsl(0, 60%, 50%, 0.2)";
                ctx.fill();
                ctx.stroke();
            },
            detectCollision: function () {
                let result = {
                    leftWall  : this.x - this.radius <= leftWall.x + leftWall.width,
                    rightWall : this.x + this.radius >= rightWall.x,
                    collides  : false,
                };
                result.collides = result.leftWall || result.rightWall;
                return result;
            },
            move: function (elapsedFrameTime) {
                this.x += getPixelInTime(this.xSpeed, elapsedFrameTime) * this.xDir;
            },
            resolveCollision: function (collision, elapsedFrameTime) {
                // TODO: fix overshoot
                ball.xDir *= -1;
            },
        };
        
        function getPixelInTime(pixelsPerSecond, elapsedFrameTime) {
            return elapsedFrameTime / 1000 * pixelsPerSecond;
        }
        
        let fps = 60;
        let lastFrameTime = Date.now();
        let fpsInterval = 1000 / fps;
        
        function draw() {
            let currentFrameTime = Date.now();
            let elapsedFrameTime = currentFrameTime - lastFrameTime;
            if (elapsedFrameTime > fpsInterval ) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                leftWall.draw();
                rightWall.draw();
                ball.move(elapsedFrameTime);
                let collision = ball.detectCollision();
                if (collision.collides) {
                    ball.resolveCollision(collision, elapsedFrameTime);
                }
                ball.draw();
                lastFrameTime = currentFrameTime - (elapsedFrameTime % fpsInterval);
            }
            updateStats();
            requestAnimationFrame(draw);
        }
        
        UI: {
            document.addEventListener("DOMContentLoaded", () => {
                let fpsInput = document.querySelector("#fpsInput");
                let canvasWidthInput = document.querySelector("#canvasWidthInput");
                let wallWidthInput = document.querySelector("#wallWidthInput");
                let ballRadiusInput = document.querySelector("#ballRadiusInput");
                let ballXSpeedInput = document.querySelector("#ballXSpeedInput");
                canvasWidthInput.addEventListener("input", () => {
                    canvas.width = canvasWidthInput.valueAsNumber || 400;
                    canvas.style.width  = canvas.width + "px";
                    canvas.style.height = canvas.height + "px";
                    rightWall.width = wallWidthInput.valueAsNumber || 400;
                    rightWall.x = canvas.width - rightWall.width;
                });
                wallWidthInput.addEventListener("input", () => {
                    leftWall.width = wallWidthInput.valueAsNumber || 400;
                    rightWall.width = wallWidthInput.valueAsNumber || 400;
                    rightWall.x = canvas.width - rightWall.width;
                });
                fpsInput.addEventListener("input", () => {
                    fps = fpsInput.valueAsNumber || 60;
                    fpsInterval = 1000 / fps;
                });
                ballRadiusInput.addEventListener("input", () => {
                    ball.radius = ballRadiusInput.valueAsNumber || 50;
                });
                ballXSpeedInput.addEventListener("input", () => {
                    ball.xSpeed = ballXSpeedInput.valueAsNumber || 50;
                });
                fpsInput.value = fps;
                canvasWidthInput.value = canvas.width;
                wallWidthInput.value = leftWall.width;
                ballRadiusInput.value = ball.radius;
                ballXSpeedInput.value = ball.xSpeed;
                
                document.querySelector("#leftWallRightDisplay").value = leftWall.x + leftWall.width;
                document.querySelector("#rightWallLeftDisplay").value = rightWall.x;
            });
            let ballXDisplay = document.querySelector("#ballXDisplay");
            let ballLeftDisplay = document.querySelector("#ballLeftDisplay");
            let ballRightDisplay = document.querySelector("#ballRightDisplay");
            function updateStats() {
                ballXDisplay.value = ball.x;
                ballLeftDisplay.value = (ball.x - ball.radius).toFixed(3);
                ballRightDisplay.value = (ball.x + ball.radius).toFixed(3);
            }
        }
        
        draw();
    </script>
</body>

</html>